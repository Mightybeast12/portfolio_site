name: Test Terraform Backend

on:
  workflow_dispatch:
  push:
    branches: [test-backend]

env:
  TF_VERSION: "1.5.0"
  TF_WORKING_DIR: "./terraform"

jobs:
  test-backend:
    name: "Test GCS Backend"
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ${{ env.TF_WORKING_DIR }}

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Enable Required APIs
        run: |
          echo "ðŸ”§ Enabling required Google Cloud APIs..."
          gcloud services enable cloudresourcemanager.googleapis.com
          gcloud services enable artifactregistry.googleapis.com
          echo "â³ Waiting for APIs to propagate..."
          sleep 30
          echo "âœ… APIs enabled!"

      - name: Test Terraform Init with Backend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "ðŸ§ª Testing Terraform backend initialization..."
          terraform init
          echo "âœ… Backend initialization successful!"

      - name: Test Terraform Plan
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "ðŸ§ª Testing Terraform plan with remote state..."
          terraform plan -var-file="secrets.tfvars" -no-color
          echo "âœ… Plan with remote state successful!"

      - name: Verify State Location
        run: |
          echo "ðŸ§ª Verifying state is stored in GCS..."
          gsutil ls gs://portfolio-site-434710-terraform-state/terraform/state/ || echo "State file not found in GCS"
          echo "âœ… State verification complete!"

      - name: Test Summary
        run: |
          echo "## ðŸ§ª Backend Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Terraform init with GCS backend" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Terraform plan with remote state" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… State stored in GCS bucket" >> $GITHUB_STEP_SUMMARY