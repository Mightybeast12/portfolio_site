name: Dependabot auto-merge
on:
  pull_request:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  dependabot:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Find and merge Dependabot PRs
        run: |
          # Get all open PRs from dependabot
          prs=$(gh pr list --author="dependabot[bot]" --state=open --json number,title,body --jq '.[].number')
          
          if [ -z "$prs" ]; then
            echo "No open Dependabot PRs found"
            exit 0
          fi
          
          echo "Found Dependabot PRs: $prs"
          
          for pr_number in $prs; do
            echo "Processing PR #$pr_number"
            
            # Approve the PR
            gh pr review --approve "$pr_number" || true
            
            # Get update type from PR body
            update_type=$(gh pr view "$pr_number" --json body --jq '.body' | grep -oP 'update-type:\s*\K[^ ]*' | head -1)
            
            # Auto-merge if patch or minor update
            if [[ "$update_type" == "version-update:semver-patch" ]] || [[ "$update_type" == "version-update:semver-minor" ]]; then
              echo "Auto-merging PR #$pr_number (type: $update_type)"
              gh pr merge --auto --squash "$pr_number" || echo "Auto-merge already enabled or PR not ready"
            else
              echo "Skipping auto-merge for PR #$pr_number (type: $update_type)"
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}